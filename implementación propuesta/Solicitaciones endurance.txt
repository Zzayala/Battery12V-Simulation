function [P_total, I_debug] = consumo_perfil_ciclos(t, V_pack)
% CONSUMO_PERFIL_CICLOS  Perfil de potencia basado en intensidad variable
%
%   [P_total, I_debug] = consumo_perfil_ciclos(t, V_pack)
%
%   t      : tiempo de simulación [s]
%   V_pack : tensión del pack [V]
%
%   P_total: potencia [W], negativa = consumo
%   I_debug: intensidad [A] para debugging

    % Obtener intensidad según el tiempo
    I = obtener_intensidad(t);

    % Salida de debug
    I_debug = I;

    % Calcular potencia: P = I * V (positiva si consume)
    P_total = -I * V_pack;  % Negativa porque es consumo
end


function I = obtener_intensidad(t)
% OBTENER_INTENSIDAD  Devuelve la intensidad [A] según el tiempo [s]
%
%   t : tiempo en segundos

    % Tabla de intensidades: [t_inicio_seg, t_fin_seg, I_amperios]
    tabla = [
        0,      120,    1.0;      % 00:00–02:00
        120,  120.15,  316.9;      % 02:00–02:01
        120.15,    135,  1.0;      % 02:01–02:15
        135,    135.15,  316.9;    % 02:15–02:18
        135.15,    180,   12.0;    % 02:18–03:00

        180,    321,   17.0;      % 03:00–05:21
        321,    322,   40.0;      % 05:21–05:22
        322,    350,   26.7;      % 05:22–05:50

        350,    363,   17.3;      % 05:50–06:06
        363,    364,   39.8;      % 06:06–06:07
        364,    380,   26.9;      % 06:07–06:25

        380,    388,   16.9;      % 06:25–06:28
        388,    389,   40.4;      % 06:28–06:29
        389,    407,   26.5;      % 06:29–06:47

        407,    423,   17.4;      % 06:47–07:03
        423,    424,   39.7;      % 07:03–07:04
        424,    442,   27.0;      % 07:04–07:22

        442,    458,   16.8;      % 07:22–07:38
        458,    459,   40.2;      % 07:38–07:39
        459,    480,   26.8;      % 07:39–08:00

        480,    495,   17.1;      % 08:00–08:15
        495,    496,   39.9;      % 08:15–08:16
        496,    522,   26.6;      % 08:16–08:42

        522,    537,   16.9;      % 08:42–08:57
        537,    538,   40.1;      % 08:57–08:58
        538,    556,   26.7;      % 08:59–09:16

        556,    581,    6.7;      % 09:17–09:40
        581,    581.15,  316.9;      % 09:41–09:43

        581.15,  606,   17.0;      % 09:44–10:06
        606,    607,   40.0;      % 10:07–10:08
        607,    626,   26.7;      % 10:09–10:26

        626,    649,   17.3;      % 10:26–10:48
        649,    650,   39.8;      % 10:49–10:50
        650,    667,   26.5;      % 10:51–11:07

        667,    691,   16.8;      % 11:08–11:30
        691,    692,   40.4;      % 11:31–11:32
        692,    709,   27.1;      % 11:33–11:49

        709,    733,   17.2;      % 11:50–12:12
        733,    734,   39.6;      % 12:13–12:14
        734,    752,   26.9;      % 12:15–12:31

        752,    775,   16.9;      % 12:32–12:54
        775,    776,   40.3;      % 12:55–12:56
        776,    793,   26.6;      % 12:57–13:13

        793,    817,   17.4;      % 13:14–13:36
        817,    818,   39.7;      % 13:37–13:38
        818,    836,   27.0;      % 13:39–13:55

        836,    859,   16.8;      % 13:56–14:18
        859,    860,   40.2;      % 14:19–14:20
        860,    877,   26.8;      % 14:21–14:37

        877,    901,   17.1;      % 14:38–15:00
        901,    902,   39.9;      % 15:01–15:02
        902,    919,   27.0;      % 15:03–15:19

        919,    943,   17.3;      % 15:20–15:42
        943,    944,   40.1;      % 15:43–15:44
        944,    950,   26.9;      % 15:45–15:50

        950,   1021,    1.0;      % 15:50–17:00
       1021,   1021.15,  316.9;    % 17:01–17:02
       1021.15,   1038,    8.0;    % 17:02–17:18
       1038,   1038.15,  316.9;    % 17:18–17:19
       1038.15,   1078,   13.0;    % 17:19–17:58

       1078,   1175,   17.7;      % 17:59–19:35
       1175,   1177,   40.1;      % 19:35–19:37
       1177,   1201,   26.9;      % 19:37–20:01

       1201,   1221,   17.7;      % 20:01–20:21
       1221,   1222,   40.1;      % 20:21–20:22
       1222,   1251,   26.9;      % 20:22–20:50

       1251,   1270,   16.9;      % 20:51–21:09
       1270,   1271,   40.3;      % 21:10–21:11
       1271,   1298,   27.2;      % 21:11–21:38

       1298,   1318,   17.4;      % 21:39–21:57
       1318,   1319,   39.8;      % 21:58–21:59
       1319,   1346,   26.8;      % 21:59–22:26

       1346,   1366,   16.8;      % 22:27–22:45
       1366,   1367,   40.1;      % 22:46–22:47
       1367,   1394,   27.3;      % 22:47–23:14

       1394,   1414,   17.2;      % 23:15–23:33
       1414,   1415,   39.9;      % 23:34–23:35
       1415,   1442,   26.7;      % 23:35–24:02

       1442,   1461,   16.9;      % 24:03–24:21
       1461,   1462,   40.2;      % 24:21–24:22
       1462,   1489,   27.1;      % 24:22–24:49

       1489,   1508,   17.4;      % 24:50–25:08
       1508,   1509,   39.8;      % 25:08–25:09
       1509,   1536,   26.8;      % 25:09–25:36

       1536,   1570,    6.7;      % 25:36–26:10
       1570,   1570.15,  316.9;    % 26:10–26:11
       1570.15,   1588,   26.8;    % 26:11–26:28

       1588,   1605,   17.4;      % 26:28–26:45
       1605,   1606,   39.8;      % 26:45–26:46
       1606,   1627,   26.8;      % 26:46–27:07

       1627,   1646,   17.1;      % 27:08–27:26
       1646,   1647,   40.0;      % 27:26–27:27
       1647,   1667,   27.0;      % 27:27–27:47

       1667,   1685,   17.3;      % 27:48–28:05
       1685,   1686,   39.7;      % 28:05–28:06
       1686,   1707,   26.9;      % 28:06–28:27

       1707,   1725,   16.9;      % 28:28–28:45
       1725,   1726,   40.2;      % 28:45–28:46
       1726,   1746,   26.8;      % 28:46–29:06

       1746,   1766,   17.4;      % 29:07–29:26
       1766,   1767,   39.9;      % 29:26–29:27
       1767,   1787,   27.1;      % 29:27–29:47

       1787,   1805,   17.0;      % 29:48–30:05
       1805,   1806,   39.8;      % 30:05–30:06
       1806,   1827,   26.7;      % 30:06–30:27

       1827,   1844,   17.2;      % 30:28–30:44
       1844,   1845,   40.1;      % 30:44–30:45
       1845,   1865,   26.9;      % 30:45–31:05

       1865,   1884,   16.8;      % 31:06–31:24
       1884,   1885,   39.8;      % 31:24–31:25
       1885,   1906,   27.2;      % 31:25–31:46

       1906,   1925,   17.5;      % 31:47–32:05
       1925,   1926,   39.9;      % 32:05–32:06
       1926,   1947,   26.8;      % 32:06–32:27

       1947,   2040,    1.1;      % 32:27–34:00
    ];

    % Buscar el tramo correspondiente al tiempo actual
    I = 0;  % Por defecto
    for k = 1:size(tabla,1)
        if t >= tabla(k,1) && t < tabla(k,2)
            I = tabla(k,3);
            break;
        end
    end

    % Si t está fuera de rango, usar el último valor
    if t >= tabla(end,2)
        I = tabla(end,3);
    end
end